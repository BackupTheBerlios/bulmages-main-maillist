<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [BulmaGés]vida sana i SQL sà
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/bulmages-main/2009-June/index.html" >
   <LINK REL="made" HREF="mailto:bulmages-main%40lists.berlios.de?Subject=Re%3A%20%3D%3Futf-8%3Fb%3FW0J1bG1hR8Opc10%3D%3F%3D%20%3D%3Fiso-8859-1%3Fq%3Fvida_sana_i_SQL_s%3DE0%3F%3D&In-Reply-To=%3C20090626205430.GA18617%40localhost%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <LINK REL="Previous"  HREF="002537.html">
   <LINK REL="Next"  HREF="002541.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[BulmaGés]vida sana i SQL sà </H1>
    <B>Xavi Drudis Ferran</B> 
    <A HREF="mailto:bulmages-main%40lists.berlios.de?Subject=Re%3A%20%3D%3Futf-8%3Fb%3FW0J1bG1hR8Opc10%3D%3F%3D%20%3D%3Fiso-8859-1%3Fq%3Fvida_sana_i_SQL_s%3DE0%3F%3D&In-Reply-To=%3C20090626205430.GA18617%40localhost%3E"
       TITLE="[BulmaGés]vida sana i SQL sà">xdrudis en tinet.cat
       </A><BR>
    <I>Vie Jun 26 22:54:30 CEST 2009</I>
    <P><UL>
        <LI>Mensaje anterior: <A HREF="002537.html">[BulmaGés] r3532 - trunk/bulmages/bulmalib/src
</A></li>
        <LI>Próximo mensaje: <A HREF="002541.html">[BulmaGés]vida sana i SQL sà
</A></li>
         <LI> <B>Mensajes ordenados por:</B> 
              <a href="date.html#2538">[ fecha ]</a>
              <a href="thread.html#2538">[ hilo ]</a>
              <a href="subject.html#2538">[ asunto ]</a>
              <a href="author.html#2538">[ autor ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Estic una mica de tip d'errors per tot arreu amb SQL que concatena de
qualsevol manera l'entrada de l'usuari (l'últim és aquest dels
apòstrofs al codi d'article que ha arreglat el Tomeu).
 
És un mal costum perquè un usuari pot entrar qualsevol cosa i si entra
un apòstrof (però hi pot haver altres casos, no sé, contrabarres, o
text en un camp numèric o similars) va i peta el programa per error
sintàctic a l'SQL. És molt frustrant per a l'usuari perquè pot perdre
dades sense cap avís previ i ha d'esperar a tornar a engegar
l'aplicació, etc., sense haver fet res mal fet.  I és frustrant per
qui vé darera a mirar el codi i es troba que no ha de corregir una
casuísitica rebuscada que no s'havia previst, o afegir una
funcionalitat o optimitzar alguna cosa, sinó que ha de fet neteja de
codi matusser.

Total que m'he emprenyat. I quan m'emprenyo pico codi i escric correus. 

A partir d'ara hi ha un mètode load a BlPostgreSqlClient que accepta
una sentència SQL amb pàrametres ($1, $2, $3...) i entre 0 i 20 valors
QString dels paràmetres. En casos senzills, que són el 95% picar SQL
correcte entri el que entri l'usuari és tan fàcil com un printf, i en
casos més complicats es pot usar el loadQuery amb un array de valors o
el sanearCadena.


Codi malsà (que decreto prohibit sota pena d'estirada d'orelles virtual):

rs = o-&gt;mainCompany()-&gt;loadQuery(&quot;SELECT columna, '&quot;+nom+&quot;' as nomcercat, '&quot;+coment+&quot;' as comentari FROM taula WHERE nom = '&quot;+nom+&quot;' &quot;)


Codi més senzill, més net, més curt, més sà, més assenyat, tan fàcil
com un printf, més segur i que no provoca petades espontànies de
l'aplicació:

rs = o-&gt;mainCompany()-&gt;load(&quot;SELECT columna, $1 as nomcercat, $2 as comentari FROM taula WHERE nom = $1&quot;,nom,coment)


Les alternatives també correctes però més complicades serien :

rs = o-&gt;mainCompany()-&gt;loadQuery(&quot;SELECT columna, '&quot;+o-&gt;mainCompany()-&gt;sanearCadena(nom)+&quot;' as nomcercat, '&quot;
+o-&gt;mainCompany()-&gt;sanearCadena(coment)+&quot;' as comentari FROM taula WHERE nom = '&quot;+o-&gt;mainCompany()-&gt;sanearCadena(nom)+&quot;' &quot;)

o 

QString valors[2] = { nom, comentari };
rs = o-&gt;mainCompany()-&gt;loadQuery(&quot;SELECT columna, $1 as nomcercat, $2 as comentari FROM taula WHERE nom = $1&quot;,2,valors);


Si el valor que introduim al SQL és numèric, i sabem que mai pot no
ser-ho (perquè prové d'un càlcul, o d'un camp numèric de la BD o
alguna cosa així, es pot concatenar tal qual (&quot;SELECT * FROM t WHERE
ID = &quot;+valorId), però és més feina pensar si és segur concatenar-ho
que optar per posar sempre $1 i passar-ho sense concatenar.



Avantatges de $1, $2 ... sobre sanearCadena (poques a bulmages):

- Evita possibles dobles escapaments si per qualsevol casúistica
s'aplica sanearCadena al resultat de sanearCadena

- És millor costum perquè en altres entorns (per exemple aplicacions
web) no escapar bé l'entrada pot ser un error de seguretat greu. A més
amb altres llibreries passant els paràmetres fora del text de la
sentència SQL es pot aconseguir portabilitat a altres BD, conversió
automàtica de tipus de dades, etc.

- Si crides sentències SQL amb $1 , $2 , $3 prepares el codi perquè en
un futur es puguin preparar sentències SQL (vol dir enviar la
sentència a la BD una vegada perquè l'analitzi i planegi l'execució i
després executar-la n vegades amb paràmetres diferents, cosa que en
versions recents de postrgreSQL i en totes les versions d'altres BD
hauria de donar més rendiment). Avui en dia bulmalib no prepara
sentències, però un dia es podria muntar alguna mena de cache de
sentències que aprofiti les que tingui preparades. Però si cada
sentència és diferent perquè porta els valors dels paràmetres
concatenats, la cache no serveix de res, si porta sempre els mateixos
$1, $2 , $3 és molt més probable trobar-la a la hipotètica cache
futura i estalviar-se anàlisi sintàctica i planificació d'execució).



Inconvenients de $1, $2 ... sobre sanearCadena :

- quan la consulta és dinàmica i es van construint afegint camps o
condicions a un where, mantenir l'array de valors pot ser més
complicat que anar concatenant cadenes passant els valors per
sanearCadena.  Es pot fer amb $1, $2, etc. però sovint no paga la
pena.



Limitacions del nou mètode load : 

- no serveix per a $21 i següents, si teniu més de 20 paràmetres useu
el loadQuery que accepta un array

- tots els paràmetres han de ser QStrings

- no admet limit ni offset ni nomcursor (però es podria afegir sense
massa complicació si es necessita sovint)


Ho vaig provar fa sis mesos i no me'n vaig sortir, n ho va fer servir
ningú. Espero tenir més sort ara i que algú faci cas. Ara caldria fer
una auditoria de codi i anar arreglant sentències per tot arreu,
perquè la gent no programa sinó que &quot;copia, pega y colorea &quot; i per
tant el codi xungo que queda es va escampant, però no sé si tindré
esma.

Apa, ja ho he dit. Bona nit.




-- 
<A HREF="https://lists.berlios.de/mailman/listinfo/bulmages-main">xdrudis en tinet.cat</A>
Signa per fer Collserola parc natural com cal
<A HREF="http://www.collserola.org/salvemelparcnatural/">http://www.collserola.org/salvemelparcnatural/</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Mensaje anterior: <A HREF="002537.html">[BulmaGés] r3532 - trunk/bulmages/bulmalib/src
</A></li>
	<LI>Próximo mensaje: <A HREF="002541.html">[BulmaGés]vida sana i SQL sà
</A></li>
         <LI> <B>Mensajes ordenados por:</B> 
              <a href="date.html#2538">[ fecha ]</a>
              <a href="thread.html#2538">[ hilo ]</a>
              <a href="subject.html#2538">[ asunto ]</a>
              <a href="author.html#2538">[ autor ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/bulmages-main">Más información sobre la lista de distribución Bulmages-main </a><br>
</body></html>
