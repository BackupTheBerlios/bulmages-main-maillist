<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [BulmaGés]No vi este mensaje.
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/bulmages-main/2012-April/index.html" >
   <LINK REL="made" HREF="mailto:bulmages-main%40lists.berlios.de?Subject=Re%3A%20%3D%3Futf-8%3Fb%3FW0J1bG1hR8Opc10%3D%3F%3D%0A%09%3D%3Fiso-8859-1%3Fq%3FNo_vi_este_mensaje%3D2E%3F%3D&In-Reply-To=%3CCAJWqEtc6rZsEb8P4Qz%3Dy7b%3DHZ8DatpAp%2B%3DVXR_d-TFmd%3DTpHsQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <LINK REL="Previous"  HREF="007137.html">
   <LINK REL="Next"  HREF="007135.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[BulmaGés]No vi este mensaje. </H1>
    <B>Tomeu Borras</B> 
    <A HREF="mailto:bulmages-main%40lists.berlios.de?Subject=Re%3A%20%3D%3Futf-8%3Fb%3FW0J1bG1hR8Opc10%3D%3F%3D%0A%09%3D%3Fiso-8859-1%3Fq%3FNo_vi_este_mensaje%3D2E%3F%3D&In-Reply-To=%3CCAJWqEtc6rZsEb8P4Qz%3Dy7b%3DHZ8DatpAp%2B%3DVXR_d-TFmd%3DTpHsQ%40mail.gmail.com%3E"
       TITLE="[BulmaGés]No vi este mensaje.">tborras en conetxia.com
       </A><BR>
    <I>Vie Abr 27 19:02:34 CEST 2012</I>
    <P><UL>
        <LI>Mensaje anterior: <A HREF="007137.html">[BulmaGés]No vi este mensaje.
</A></li>
        <LI>Próximo mensaje: <A HREF="007135.html">[BulmaGés] [Gitorious] Activity: tborras pushed 1	commits to release...
</A></li>
         <LI> <B>Mensajes ordenados por:</B> 
              <a href="date.html#7138">[ fecha ]</a>
              <a href="thread.html#7138">[ hilo ]</a>
              <a href="subject.html#7138">[ asunto ]</a>
              <a href="author.html#7138">[ autor ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>El 27 de abril de 2012 17:02, Cristian Garde Zarza &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bulmages-main">cristian.garde at gmail.com</A>
&gt;<i> escribió:
</I>
&gt;<i>
</I>&gt;<i>
</I>&gt;<i> El 27 de abril de 2012 14:38, Tomeu Borras &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/bulmages-main">tborras at conetxia.com</A>&gt;escribió:
</I>&gt;<i>
</I>&gt;<i> Hola Tomeu,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Como no indicas qué es lo que está fallando no puedo hacer ninguna
</I>&gt;&gt;&gt;<i> prueba más allá de comprobar que el uso del valor de IRPF en los documentos
</I>&gt;&gt;&gt;<i> como albaranes, facturas, etc, funciona correctamente aunque en la base de
</I>&gt;&gt;&gt;<i> datos haya una 'coma' como separador decimal. Ten en cuenta que el campo
</I>&gt;&gt;&gt;<i> 'valor' es de tipo 'varchar' y por tanto el programa debería estar
</I>&gt;&gt;&gt;<i> preparado para recibir este tipo de datos y tratarlos bien. No obstante he
</I>&gt;&gt;&gt;<i> cambiado la captura de datos del BlDoubleSpinBox de text() a value() que
</I>&gt;&gt;&gt;<i> devuelve un 'double' y por tanto el separador decimal es un punto.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Creo que dije que fallaba todo. Era literal.
</I>&gt;&gt;<i> No se pueden guardar presupuestos, pedidos, albarantes ni facturas. No se
</I>&gt;&gt;<i> puede pasar de presupuesto a factura ni ninguna de las transferencias
</I>&gt;&gt;<i> soportadas.
</I>&gt;&gt;<i> El problema se deriva de las funciones calctotal.... que son disparadas
</I>&gt;&gt;<i> en la base de datos y hacen un casting del valor del irpf a punto fijo
</I>&gt;&gt;<i> (numeric 12,2). Al encontrar una coma no pueden traducir el valor  y fallan
</I>&gt;&gt;<i> los disparadores (consecuentemente falla todo).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Te dije exactamente cual era el problema y además añadí como solventarlo,
</I>&gt;&gt;<i> deduzco que las pruebas que has realizado son &quot;escuetas&quot; si no has podido
</I>&gt;&gt;<i> darte cuenta.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Y ya de paso dejamé comentar que la solución subida no es correcta porque
</I>&gt;&gt;<i> el tipo Double no es convertible en String y puede devolver un valor del
</I>&gt;&gt;<i> tipo 3.45577888E89 (notación científica) la cual tampoco va a funcionar. Es
</I>&gt;&gt;<i> preferible un text().replace(',','.'), usar las locales o derivar el
</I>&gt;&gt;<i> SpinBox para que devuelva los valores como toca.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ¿Cómo que double no se puede convertir en string? todo se puede convertir
</I>&gt;<i> en un string y concretamente el QDoubleSpinBox no saca en ningún caso el
</I>&gt;<i> 'value' en notación científica COMPROBADO.
</I>&gt;<i>
</I>
Concretamente te saca un valor del tipo double lo que significa que no es
QDoubleSpinBox quien convierte el valor en String. Son las Qt, las stdlib,
el compilador y el procesador en última instancia. Hay que comprobar mucho
para estar 100% seguro.



&gt;<i> Además, hay que saber de qué estamos hablando. Es un campo para
</I>&gt;<i> especificar el porcentaje de IRPF que se aplica de retención. ¿Cuántos
</I>&gt;<i> decimales necesitas para esto? ¿y la parte entera? ¿o vas a tener una
</I>&gt;<i> retención de 100000.123123123% ? es absurdo. El campo 'valor' tiene una
</I>&gt;<i> capacidad de 350 caracteres ¿quieres que se pueda escribir un número tan
</I>&gt;<i> grande? No. Lo lógico es limitar a valores razonables con 3+2 máximo. Aquí
</I>&gt;<i> si que puede estar mal porque lo he puesto a 2 enteros, pero lo cambio.
</I>&gt;<i> ¿Conoces algún caso de retención por encima del 100%?
</I>&gt;<i>
</I>&gt;<i> Ejemplo práctico de porque no se debe utilizar el tipo double ni el float:
</I>
#include &lt;stdio.h&gt;

main() {

float a;
float b=67;

for (a=0; a&lt;10; a+=0.01) {
    if ( a != (((a/(b*100))*b)*100) )
        printf(&quot;%f != %f\n&quot;,a,((a/(b*100))*b)*100);
} // end for

}


Es el caso correspondiente a aplicar un porcentaje y desaplicarlo. Es
decir, es el caso más simple que nos encontramos ya que no hace sumatorios,
porcentajes dobles ni comparativas. Fijate que los incrementos son de 0.01
(es decir un 1% de margen). Deacuerdo que son floats pero en double sólo
cambias la precisión en unos cálculos que pueden ser mucho más complejos.

La lógica te dirá que el resultado debe ser nada, pero en realidad
obtendrás una ristra de números tal que así:

0.030000 != 0.030000
0.110000 != 0.110000
0.120000 != 0.120000
0.390000 != 0.390000
0.430000 != 0.430000
0.440000 != 0.440000
0.450000 != 0.450000
0.460000 != 0.460000
0.480000 != 0.480000
0.500000 != 0.500000
0.530000 != 0.530000
0.550000 != 0.550000
0.580000 != 0.580000
0.790000 != 0.789999
0.800000 != 0.800000
0.810000 != 0.810000
0.820000 != 0.819999
0.889999 != 0.889999
0.899999 != 0.899999
0.909999 != 0.909999
0.919999 != 0.919999
0.929999 != 0.929999
0.959999 != 0.959999
0.999999 != 0.999999
1.009999 != 1.009999
1.049999 != 1.049999
1.109999 != 1.109999
1.189999 != 1.189999
1.249999 != 1.249999
1.349999 != 1.349999
1.359999 != 1.359999
1.439999 != 1.439999
1.499999 != 1.499999
1.539999 != 1.539999
1.599999 != 1.599999
1.609999 != 1.609999
1.619999 != 1.619999
1.629999 != 1.629999
1.639999 != 1.639999
1.649999 != 1.649999
1.659999 != 1.659999
1.669999 != 1.669999
1.679999 != 1.679999
1.689999 != 1.689999
1.719999 != 1.719999
1.799999 != 1.799999
1.809999 != 1.809999
1.849999 != 1.849998
1.859999 != 1.859998
1.869999 != 1.869999
1.879999 != 1.879999
1.889999 != 1.889999
1.899999 != 1.899999
1.909999 != 1.909998
1.919999 != 1.919998
1.929999 != 1.929998
1.939999 != 1.939999
2.029999 != 2.029998
2.179998 != 2.179999
2.189998 != 2.189999
2.299998 != 2.299998
2.309998 != 2.309998
2.389998 != 2.389998
2.669998 != 2.669998
2.679998 != 2.679998
2.789998 != 2.789998
2.799998 != 2.799998
2.879998 != 2.879998
2.949998 != 2.949998
3.079998 != 3.079997
3.139997 != 3.139997
3.159997 != 3.159998
3.179997 != 3.179998
3.269997 != 3.269997
3.289997 != 3.289997
3.309997 != 3.309997
3.329997 != 3.329997
3.349997 != 3.349998
3.369997 != 3.369998
3.389997 != 3.389997
3.409997 != 3.409997
3.419997 != 3.419997
3.429997 != 3.429997
3.449997 != 3.449997
3.469997 != 3.469997
3.539997 != 3.539997
3.559997 != 3.559997
3.579997 != 3.579997
3.599997 != 3.599997
3.619997 != 3.619997
3.639997 != 3.639997
3.659997 != 3.659997
3.679997 != 3.679997
3.769997 != 3.769997
3.789997 != 3.789997
3.809997 != 3.809997
3.819997 != 3.819997
3.829997 != 3.829997
3.849997 != 3.849997
3.869997 != 3.869997
3.889997 != 3.889997
3.909997 != 3.909997
3.929997 != 3.929997
3.949997 != 3.949997
3.979997 != 3.979997
3.999997 != 3.999997
4.029997 != 4.029997
4.039998 != 4.039997
4.089999 != 4.089998
4.370005 != 4.370006
4.380005 != 4.380006
4.430007 != 4.430007
4.440007 != 4.440007
4.460007 != 4.460007
4.470007 != 4.470007
4.530009 != 4.530008
4.810015 != 4.810016
4.870017 != 4.870017
4.880017 != 4.880017
4.900017 != 4.900017
4.910017 != 4.910017
4.960019 != 4.960018
4.970019 != 4.970018
5.250025 != 5.250026
5.300026 != 5.300027
5.310027 != 5.310027
5.340027 != 5.340027
5.350028 != 5.350027
5.400029 != 5.400028
5.460030 != 5.460030
5.630034 != 5.630034
5.690035 != 5.690036
5.740036 != 5.740037
5.750037 != 5.750037
5.780037 != 5.780037
5.790038 != 5.790037
5.840039 != 5.840038
5.900040 != 5.900040
6.130045 != 6.130046
6.180047 != 6.180047
6.190047 != 6.190047
6.210047 != 6.210047
6.220047 != 6.220047
6.230048 != 6.230047
6.250048 != 6.250049
6.340050 != 6.340051
6.350050 != 6.350051
6.360051 != 6.360051
6.370051 != 6.370051
6.380051 != 6.380052
6.460053 != 6.460052
6.470053 != 6.470053
6.480053 != 6.480053
6.490054 != 6.490053
6.500054 != 6.500053
6.590056 != 6.590056
6.600056 != 6.600057
6.610056 != 6.610057
6.620057 != 6.620057
6.630057 != 6.630057
6.700058 != 6.700059
6.710059 != 6.710059
6.720059 != 6.720059
6.730059 != 6.730060
6.740059 != 6.740060
6.750060 != 6.750060
6.810061 != 6.810061
6.820061 != 6.820062
6.830061 != 6.830062
6.840062 != 6.840062
6.850062 != 6.850062
6.860062 != 6.860063
6.870062 != 6.870063
6.880063 != 6.880062
6.890063 != 6.890062
6.900063 != 6.900063
6.910063 != 6.910063
6.960064 != 6.960064
6.970065 != 6.970064
6.980065 != 6.980064
6.990065 != 6.990065
7.000065 != 7.000065
7.010066 != 7.010065
7.020066 != 7.020065
7.090067 != 7.090067
7.100068 != 7.100067
7.110068 != 7.110067
7.120068 != 7.120068
7.130068 != 7.130068
7.210070 != 7.210070
7.220070 != 7.220070
7.230071 != 7.230070
7.240071 != 7.240070
7.250071 != 7.250072
7.340073 != 7.340073
7.350073 != 7.350073
7.360074 != 7.360074
7.370074 != 7.370074
7.380074 != 7.380075
7.460076 != 7.460075
7.470076 != 7.470077
7.480076 != 7.480077
7.490077 != 7.490077
7.500077 != 7.500077
7.580079 != 7.580079
7.590079 != 7.590079
7.600079 != 7.600080
7.610079 != 7.610080
7.620080 != 7.620080
7.630080 != 7.630080
7.690081 != 7.690082
7.700081 != 7.700082
7.710082 != 7.710082
7.720082 != 7.720082
7.730082 != 7.730083
7.740082 != 7.740083
7.750082 != 7.750082
7.760083 != 7.760082
7.770083 != 7.770082
7.780083 != 7.780083
7.790083 != 7.790083
7.840085 != 7.840084
7.850085 != 7.850084
7.860085 != 7.860085
7.870085 != 7.870085
7.880085 != 7.880085
7.890086 != 7.890085
7.960087 != 7.960087
7.970088 != 7.970087
7.980088 != 7.980087
7.990088 != 7.990088
8.410097 != 8.410098
8.520100 != 8.520101
8.530100 != 8.530101
8.540100 != 8.540101
8.600101 != 8.600101
8.610102 != 8.610101
8.620102 != 8.620101
8.630102 != 8.630103
8.710104 != 8.710103
8.720104 != 8.720103
8.730104 != 8.730103
8.840107 != 8.840106
9.290117 != 9.290118
9.390120 != 9.390121
9.400120 != 9.400121
9.410120 != 9.410121
9.490122 != 9.490121
9.500122 != 9.500123
9.590124 != 9.590123
9.600124 != 9.600123
9.710127 != 9.710126


&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Igual resulta difícil de entender que el punto flotante es lo peor que
</I>&gt;&gt;<i> puedes usar para expresar valores en punto fijo y que el punto fijo no esta
</I>&gt;&gt;<i> soportado en C++, y que no es preciso.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> He visto que el siguiente commit de fecha 3/Feb/2011 comentastes un
</I>&gt;&gt;&gt;<i> código que trataba de solucionar el tema si se usaba text() para capturar
</I>&gt;&gt;&gt;<i> el valor del BlDoubleSpinBox. No indicas el motivo por el que se comentó el
</I>&gt;&gt;&gt;<i> código, pero el comentario sigue allí todavía.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> COPIO/PEGO:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> commit SHA1 ID: 7052c1db4dd37488b15f5c365c99155a499d3250
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Deshago los cambios en BlDoubleSpinBox que convierten los números al
</I>&gt;&gt;&gt;<i> formato según locales.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ------------------ bulmages/bulmalib/src/bldoublespinbox.cpp
</I>&gt;&gt;&gt;<i> ------------------
</I>&gt;&gt;&gt;<i> index 8ddec8e..c6068ef 100644
</I>&gt;&gt;&gt;<i> @@ -54,10 +54,10 @@ QString const BlDoubleSpinBox::text()
</I>&gt;&gt;&gt;<i>      blDebug ( &quot;BlDoubleSpinBox::text&quot;, 0 );
</I>&gt;&gt;&gt;<i>      QString a = QDoubleSpinBox::text();
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -    /// Conversi&oacute;n al formato del locale &quot;C&quot;: un punto separa la
</I>&gt;&gt;&gt;<i> parte decimal
</I>&gt;&gt;&gt;<i> +/*    /// Conversi&oacute;n al formato del locale &quot;C&quot;: un punto separa
</I>&gt;&gt;&gt;<i> la parte decimal
</I>&gt;&gt;&gt;<i>      QLocale locale;
</I>&gt;&gt;&gt;<i>      a = locale.toString((locale.toDouble(a))); //ARON
</I>&gt;&gt;&gt;<i> -
</I>&gt;&gt;&gt;<i> +*/
</I>&gt;&gt;&gt;<i>      blDebug ( &quot;END BlDoubleSpinBox::text&quot;, 0, a );
</I>&gt;&gt;&gt;<i>      return a;
</I>&gt;&gt;&gt;<i>  }
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Exactamente por el mismo motivo que te he comentado. No se puede pasar de
</I>&gt;&gt;<i> Double a String esperando que devuelva un valor entendible por los humanos
</I>&gt;&gt;<i> o en el formato adecuado, y aun así no puedes esperar que éste sea preciso.
</I>&gt;&gt;<i> En gestión se requiere exactitud y no precisión milimétrica.
</I>&gt;&gt;<i> De hecho no se pueden usar los Doubles, los Float ni nada de punto
</I>&gt;&gt;<i> flotante porque no son exactos, de ahi que usemos la clase BlFixed.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> No entiendo tu preocupación. Sólo cojo el valor, lo paso a string y lo
</I>&gt;<i> guardo en la base de datos. No lo uso para
</I>&gt;<i>
</I>
Porque han dado problemas a diestro y siniestro (problemas muy graves y
difíciles de detectar).

Porque los QDoubleSpinBox no aportan nada bueno. Sólo que te equivoques
pulsando con el botón a las flechas y cambies el valor sin querer.

Porque hacer un rgrep double en el código y no encontrar nada es garantía
de calidad.

Y porque no puedes estar 100% seguro del resultado de esa conversión (ESTO
SI COMPROBADO).



&gt;<i> calcular nada, con lo que no hay problemas. Además la otra solución que
</I>&gt;<i> propones de reemplazar la coma por el punto no es factible en el caso del
</I>&gt;<i> QDoubleSpinBox porque el método 'text()' devuelve también el prefijo o
</I>&gt;<i> sufijo asignado y eso puede estropear el valor numérico al guardarlo en la
</I>&gt;<i> base de datos.
</I>&gt;<i>
</I>
Entonces deriva el QDoubleSpinBox y haz un BlDoubleSpinBox que devuelva un
BlFixed (sin usar double) ya que, tarde o temprano, tendremos que hacerlo.


&gt;<i>
</I>&gt;&gt;&gt;<i> Hago notar que antes de este cambio, en la ficha 'modo experto' de la
</I>&gt;&gt;&gt;<i> configuración, en el capo 'IRPF' al ser de texto libre también se podría
</I>&gt;&gt;&gt;<i> haber escrito un número con 'coma' y también hubiese dado el mismo fallo
</I>&gt;&gt;&gt;<i> que comentas, pero que no se cual es. Ahora está mucho más protegido porque
</I>&gt;&gt;&gt;<i> el valor del BlDoubleSpinBox tiene prioridad sobre ese campo y evitará que
</I>&gt;&gt;&gt;<i> se pueda escribir un valor erróneo.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Precisamente por ese motivo lo puse en modo experto, es algo que si lo
</I>&gt;&gt;<i> tocas te puede dar muchos problemas, y soy de la opinión que debería seguir
</I>&gt;&gt;<i> en el modo experto.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Y ya que te quejas de que sea un texto, explicame como lo solucionarías
</I>&gt;&gt;<i> de forma que la complejidad resultante sea menor que la solución actual
</I>&gt;&gt;<i> contemplando la inconveniencia de hacer casting.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>Tomeu Borrás
Conetxia Soluciones Informáticas
902 88 11 66 - 677 77 44 76
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://lists.berlios.de/pipermail/bulmages-main/attachments/20120427/fc5ea7a9/attachment-0001.html">https://lists.berlios.de/pipermail/bulmages-main/attachments/20120427/fc5ea7a9/attachment-0001.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Mensaje anterior: <A HREF="007137.html">[BulmaGés]No vi este mensaje.
</A></li>
	<LI>Próximo mensaje: <A HREF="007135.html">[BulmaGés] [Gitorious] Activity: tborras pushed 1	commits to release...
</A></li>
         <LI> <B>Mensajes ordenados por:</B> 
              <a href="date.html#7138">[ fecha ]</a>
              <a href="thread.html#7138">[ hilo ]</a>
              <a href="subject.html#7138">[ asunto ]</a>
              <a href="author.html#7138">[ autor ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/bulmages-main">Más información sobre la lista de distribución Bulmages-main </a><br>
</body></html>
